import requests
from bs4 import BeautifulSoup
import pandas as pd
from tqdm import tqdm
import os
from datetime import datetime

# -------------------------------------------------
# CONFIGURAÃ‡Ã•ES
# -------------------------------------------------
URL_BASE = "https://sdm.min-saude.pt/bi.aspx?id="
ID_INICIO = 0
ID_FIM = 510
FICHEIRO_XLSX = "indicadores.xlsx"
FICHEIRO_HTML = "indicadores.html"
# -------------------------------------------------

def extrair_texto_de_tabela(soup, titulo):
    """Procura a tabela que contÃ©m um <b> com o tÃ­tulo dado
    e devolve o texto da cÃ©lula imediatamente a seguir."""
    for b in soup.find_all("b"):
        if titulo.lower() in b.get_text(strip=True).lower():
            table = b.find_parent("table")
            if not table:
                continue
            next_tr = table.find_next_sibling("tr")
            if next_tr:
                return next_tr.get_text(" ", strip=True)
            tds = table.find_all("td")
            if len(tds) > 1:
                return tds[-1].get_text(" ", strip=True)
    return "â€”"

def recolher_indicador(i):
    """Recolhe os dados de um indicador a partir da pÃ¡gina HTML."""
    url = f"{URL_BASE}{i}"
    try:
        resp = requests.get(url, timeout=15)
        if resp.status_code != 200:
            return None
        soup = BeautifulSoup(resp.text, "html.parser")
        main = soup

        designacao = extrair_texto_de_tabela(main, "DesignaÃ§Ã£o")
        descricao = extrair_texto_de_tabela(main, "DescriÃ§Ã£o do Indicador")
        estado = extrair_texto_de_tabela(main, "Estado do indicador")
        intervalo = extrair_texto_de_tabela(main, "Intervalo Esperado")
        variacao = extrair_texto_de_tabela(main, "VariaÃ§Ã£o AceitÃ¡vel")

        return {
            "ID indicador": i,
            "Link": url,
            "DesignaÃ§Ã£o": designacao,
            "DescriÃ§Ã£o do Indicador": descricao,
            "Estado do indicador": estado,
            "Intervalo Esperado": intervalo,
            "VariaÃ§Ã£o AceitÃ¡vel": variacao,
        }

    except Exception:
        return None

# -------------------------------------------------
# ETAPA 1: Carregar IDs jÃ¡ existentes (se houver Excel)
# -------------------------------------------------
ids_existentes = set()
if os.path.exists(FICHEIRO_XLSX):
    print(f"ðŸ“˜ A ler ficheiro existente: {FICHEIRO_XLSX}")
    df_existente = pd.read_excel(FICHEIRO_XLSX)
    if "ID indicador" in df_existente.columns:
        ids_existentes = set(df_existente["ID indicador"].dropna().astype(int))
        print(f"ðŸ§© {len(ids_existentes)} indicadores jÃ¡ existentes.")
else:
    df_existente = pd.DataFrame()

# -------------------------------------------------
# ETAPA 2: Recolher apenas os novos
# -------------------------------------------------
dados = []
for i in tqdm(range(ID_INICIO, ID_FIM + 1), desc="A recolher indicadores"):
    if i in ids_existentes:
        continue  # jÃ¡ recolhido
    item = recolher_indicador(i)
    if item:
        dados.append(item)

print(f"âœ… Novos indicadores recolhidos: {len(dados)}")

# -------------------------------------------------
# ETAPA 3: Atualizar e guardar os ficheiros
# -------------------------------------------------
if dados:
    novos_df = pd.DataFrame(dados)
    if not df_existente.empty:
        df_final = pd.concat([df_existente, novos_df], ignore_index=True)
    else:
        df_final = novos_df

    df_final.to_excel(FICHEIRO_XLSX, index=False)
    print(f"ðŸ“— Ficheiro '{FICHEIRO_XLSX}' atualizado com sucesso!")
else:
    df_final = df_existente
    print("ðŸ“˜ Nenhum indicador novo para adicionar.")

# -------------------------------------------------
# ETAPA 4: Gerar o HTML com data, filtro e tabela interativa
# -------------------------------------------------
data_atual = datetime.now().strftime("%d/%m/%Y %H:%M")
html_tabela = df_final.to_html(index=False, border=0, classes="display", table_id="tabela")

html_completo = f"""
<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>Indicadores SDM</title>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script>
$(document).ready(function() {{
    var table = $('#tabela').DataTable({{
        language: {{
            url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/pt-PT.json'
        }},
        pageLength: 20
    }});

    // --- Criar filtro de Estado ---
    var estados = [];
    table.column(4).data().each(function(value) {{
        if (value && estados.indexOf(value) === -1) {{
            estados.push(value);
        }}
    }});
    estados.sort();

    var filtro = $('<label>ðŸ”½ Filtro por Estado: <select id="filtroEstado"><option value="">Todos</option></select></label>');
    estados.forEach(function(e) {{
        $('#filtroEstado', filtro).append('<option value="'+e+'">'+e+'</option>');
    }});
    $('#data').after(filtro);

    // --- Aplicar filtro ao mudar seleÃ§Ã£o ---
    $('#filtroEstado').on('change', function() {{
        var val = $.fn.dataTable.util.escapeRegex($(this).val());
        table.column(4).search(val ? '^'+val+'$' : '', true, false).draw();
    }});
}});
</script>
<style>
body {{
    font-family: Arial, sans-serif;
    margin: 40px;
}}
h1 {{
    color: #003366;
}}
#data {{
    font-size: 14px;
    color: #555;
    margin-bottom: 20px;
}}
label {{
    font-size: 14px;
    color: #333;
    margin-left: 10px;
}}
select {{
    margin-left: 8px;
    padding: 4px;
}}
</style>
</head>
<body>
<h1>Bilhete de Identidade dos Indicadores SDM</h1>
<div id="data">ðŸ“… Atualizado em {data_atual}</div>
<p>Fonte: <a href="https://sdm.min-saude.pt/">SDM - Sistema de Desempenho em SaÃºde</a></p>
{html_tabela}
</body>
</html>
"""

with open(FICHEIRO_HTML, "w", encoding="utf-8") as f:
    f.write(html_completo)

print(f"âœ… Ficheiro '{FICHEIRO_HTML}' atualizado com sucesso com filtro de Estado!")
